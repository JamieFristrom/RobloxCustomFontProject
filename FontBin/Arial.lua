bmfont = [[info font="Arial" size=64 bold=0 italic=0 charset="" unicode=0 stretchH=100 smooth=1 aa=1 padding=2,2,2,2 spacing=2,2
common lineHeight=99 base=77 scaleW=1024 scaleH=512 pages=1 packed=0
page id=0 file="test.png"
chars count=97
char id=40 x=2 y=2 width=25 height=84 xoffset=6 yoffset=13 xadvance=28 page=0 chnl=0 letter="("
char id=41 x=29 y=2 width=25 height=84 xoffset=4 yoffset=13 xadvance=28 page=0 chnl=0 letter=")"
char id=64 x=56 y=2 width=83 height=84 xoffset=6 yoffset=12 xadvance=86 page=0 chnl=0 letter="@"
char id=125 x=141 y=2 width=29 height=84 xoffset=1 yoffset=12 xadvance=28 page=0 chnl=0 letter="}"
char id=124 x=172 y=2 width=11 height=84 xoffset=9 yoffset=13 xadvance=22 page=0 chnl=0 letter="|"
char id=123 x=185 y=2 width=29 height=84 xoffset=3 yoffset=12 xadvance=28 page=0 chnl=0 letter="{"
char id=106 x=216 y=2 width=21 height=83 xoffset=-2 yoffset=13 xadvance=20 page=0 chnl=0 letter="j"
char id=91 x=239 y=2 width=21 height=82 xoffset=6 yoffset=13 xadvance=24 page=0 chnl=0 letter="["
char id=93 x=262 y=2 width=21 height=82 xoffset=3 yoffset=13 xadvance=24 page=0 chnl=0 letter="]"
char id=36 x=285 y=2 width=45 height=80 xoffset=4 yoffset=10 xadvance=47 page=0 chnl=0 letter="$"
char id=81 x=332 y=2 width=64 height=71 xoffset=5 yoffset=12 xadvance=66 page=0 chnl=0 letter="Q"
char id=37 x=398 y=2 width=70 height=69 xoffset=6 yoffset=12 xadvance=76 page=0 chnl=0 letter="%"
char id=38 x=470 y=2 width=56 height=68 xoffset=5 yoffset=12 xadvance=57 page=0 chnl=0 letter="&"
char id=57 x=528 y=2 width=45 height=67 xoffset=5 yoffset=13 xadvance=47 page=0 chnl=0 letter="9"
char id=56 x=575 y=2 width=45 height=67 xoffset=5 yoffset=13 xadvance=47 page=0 chnl=0 letter="8"
char id=103 x=622 y=2 width=43 height=67 xoffset=4 yoffset=29 xadvance=47 page=0 chnl=0 letter="g"
char id=71 x=667 y=2 width=61 height=67 xoffset=5 yoffset=12 xadvance=66 page=0 chnl=0 letter="G"
char id=67 x=730 y=2 width=58 height=67 xoffset=5 yoffset=12 xadvance=61 page=0 chnl=0 letter="C"
char id=54 x=790 y=2 width=45 height=67 xoffset=3 yoffset=13 xadvance=47 page=0 chnl=0 letter="6"
char id=83 x=837 y=2 width=53 height=67 xoffset=5 yoffset=12 xadvance=57 page=0 chnl=0 letter="S"
char id=92 x=892 y=2 width=28 height=67 xoffset=2 yoffset=13 xadvance=24 page=0 chnl=0 letter="\"
char id=79 x=922 y=2 width=63 height=67 xoffset=5 yoffset=12 xadvance=66 page=0 chnl=0 letter="O"
char id=47 x=987 y=2 width=28 height=67 xoffset=1 yoffset=13 xadvance=24 page=0 chnl=0 letter="/"
char id=35 x=2 y=88 width=50 height=67 xoffset=1 yoffset=13 xadvance=47 page=0 chnl=0 letter="#"
char id=51 x=54 y=88 width=44 height=67 xoffset=5 yoffset=13 xadvance=47 page=0 chnl=0 letter="3"
char id=48 x=100 y=88 width=44 height=67 xoffset=5 yoffset=13 xadvance=47 page=0 chnl=0 letter="0"
char id=102 x=146 y=88 width=30 height=66 xoffset=3 yoffset=12 xadvance=24 page=0 chnl=0 letter="f"
char id=74 x=178 y=88 width=38 height=66 xoffset=4 yoffset=13 xadvance=43 page=0 chnl=0 letter="J"
char id=49 x=218 y=88 width=27 height=66 xoffset=10 yoffset=13 xadvance=47 page=0 chnl=0 letter="1"
char id=63 x=247 y=88 width=44 height=66 xoffset=5 yoffset=12 xadvance=47 page=0 chnl=0 letter="?"
char id=98 x=293 y=88 width=43 height=66 xoffset=7 yoffset=13 xadvance=47 page=0 chnl=0 letter="b"
char id=100 x=338 y=88 width=43 height=66 xoffset=4 yoffset=13 xadvance=47 page=0 chnl=0 letter="d"
char id=121 x=383 y=88 width=45 height=66 xoffset=2 yoffset=30 xadvance=41 page=0 chnl=0 letter="y"
char id=50 x=430 y=88 width=45 height=66 xoffset=3 yoffset=13 xadvance=47 page=0 chnl=0 letter="2"
char id=53 x=477 y=88 width=45 height=66 xoffset=5 yoffset=14 xadvance=47 page=0 chnl=0 letter="5"
char id=85 x=524 y=88 width=52 height=66 xoffset=8 yoffset=13 xadvance=61 page=0 chnl=0 letter="U"
char id=113 x=578 y=88 width=43 height=66 xoffset=4 yoffset=29 xadvance=47 page=0 chnl=0 letter="q"
char id=112 x=623 y=88 width=43 height=66 xoffset=7 yoffset=29 xadvance=47 page=0 chnl=0 letter="p"
char id=52 x=668 y=88 width=47 height=65 xoffset=2 yoffset=14 xadvance=47 page=0 chnl=0 letter="4"
char id=87 x=717 y=88 width=83 height=65 xoffset=2 yoffset=13 xadvance=85 page=0 chnl=0 letter="W"
char id=88 x=802 y=88 width=60 height=65 xoffset=1 yoffset=13 xadvance=56 page=0 chnl=0 letter="X"
char id=89 x=864 y=88 width=60 height=65 xoffset=2 yoffset=13 xadvance=56 page=0 chnl=0 letter="Y"
char id=76 x=926 y=88 width=43 height=65 xoffset=8 yoffset=13 xadvance=47 page=0 chnl=0 letter="L"
char id=75 x=2 y=157 width=55 height=65 xoffset=8 yoffset=13 xadvance=57 page=0 chnl=0 letter="K"
char id=105 x=59 y=157 width=12 height=65 xoffset=7 yoffset=13 xadvance=19 page=0 chnl=0 letter="i"
char id=72 x=73 y=157 width=52 height=65 xoffset=8 yoffset=13 xadvance=61 page=0 chnl=0 letter="H"
char id=116 x=127 y=157 width=26 height=65 xoffset=2 yoffset=15 xadvance=24 page=0 chnl=0 letter="t"
char id=107 x=155 y=157 width=41 height=65 xoffset=7 yoffset=13 xadvance=44 page=0 chnl=0 letter="k"
char id=86 x=198 y=157 width=60 height=65 xoffset=0 yoffset=13 xadvance=57 page=0 chnl=0 letter="V"
char id=108 x=260 y=157 width=12 height=65 xoffset=7 yoffset=13 xadvance=19 page=0 chnl=0 letter="l"
char id=90 x=274 y=157 width=53 height=65 xoffset=3 yoffset=13 xadvance=52 page=0 chnl=0 letter="Z"
char id=70 x=329 y=157 width=46 height=65 xoffset=8 yoffset=13 xadvance=52 page=0 chnl=0 letter="F"
char id=84 x=377 y=157 width=53 height=65 xoffset=3 yoffset=13 xadvance=52 page=0 chnl=0 letter="T"
char id=33 x=432 y=157 width=14 height=65 xoffset=11 yoffset=13 xadvance=28 page=0 chnl=0 letter="!"
char id=68 x=448 y=157 width=55 height=65 xoffset=8 yoffset=13 xadvance=61 page=0 chnl=0 letter="D"
char id=65 x=505 y=157 width=61 height=65 xoffset=1 yoffset=13 xadvance=57 page=0 chnl=0 letter="A"
char id=55 x=568 y=157 width=44 height=65 xoffset=5 yoffset=14 xadvance=47 page=0 chnl=0 letter="7"
char id=66 x=614 y=157 width=50 height=65 xoffset=8 yoffset=13 xadvance=57 page=0 chnl=0 letter="B"
char id=104 x=666 y=157 width=40 height=65 xoffset=7 yoffset=13 xadvance=47 page=0 chnl=0 letter="h"
char id=80 x=708 y=157 width=51 height=65 xoffset=8 yoffset=13 xadvance=57 page=0 chnl=0 letter="P"
char id=77 x=761 y=157 width=63 height=65 xoffset=8 yoffset=13 xadvance=71 page=0 chnl=0 letter="M"
char id=73 x=826 y=157 width=13 height=65 xoffset=9 yoffset=13 xadvance=24 page=0 chnl=0 letter="I"
char id=78 x=841 y=157 width=52 height=65 xoffset=8 yoffset=13 xadvance=61 page=0 chnl=0 letter="N"
char id=82 x=895 y=157 width=58 height=65 xoffset=8 yoffset=13 xadvance=61 page=0 chnl=0 letter="R"
char id=69 x=955 y=157 width=50 height=65 xoffset=8 yoffset=13 xadvance=57 page=0 chnl=0 letter="E"
char id=59 x=1007 y=157 width=14 height=61 xoffset=9 yoffset=30 xadvance=24 page=0 chnl=0 letter=";"
char id=115 x=2 y=224 width=41 height=51 xoffset=4 yoffset=29 xadvance=43 page=0 chnl=0 letter="s"
char id=101 x=45 y=224 width=45 height=51 xoffset=4 yoffset=29 xadvance=47 page=0 chnl=0 letter="e"
char id=99 x=92 y=224 width=43 height=51 xoffset=4 yoffset=29 xadvance=43 page=0 chnl=0 letter="c"
char id=111 x=137 y=224 width=46 height=51 xoffset=4 yoffset=29 xadvance=47 page=0 chnl=0 letter="o"
char id=97 x=185 y=224 width=45 height=51 xoffset=4 yoffset=29 xadvance=47 page=0 chnl=0 letter="a"
char id=114 x=232 y=224 width=28 height=50 xoffset=7 yoffset=29 xadvance=28 page=0 chnl=0 letter="r"
char id=109 x=262 y=224 width=64 height=50 xoffset=7 yoffset=29 xadvance=72 page=0 chnl=0 letter="m"
char id=117 x=328 y=224 width=40 height=50 xoffset=7 yoffset=30 xadvance=47 page=0 chnl=0 letter="u"
char id=110 x=370 y=224 width=40 height=50 xoffset=7 yoffset=29 xadvance=47 page=0 chnl=0 letter="n"
char id=122 x=412 y=224 width=44 height=49 xoffset=2 yoffset=30 xadvance=41 page=0 chnl=0 letter="z"
char id=58 x=458 y=224 width=13 height=49 xoffset=9 yoffset=30 xadvance=24 page=0 chnl=0 letter=":"
char id=118 x=473 y=224 width=45 height=49 xoffset=2 yoffset=30 xadvance=43 page=0 chnl=0 letter="v"
char id=119 x=520 y=224 width=65 height=49 xoffset=0 yoffset=30 xadvance=61 page=0 chnl=0 letter="w"
char id=120 x=587 y=224 width=46 height=49 xoffset=2 yoffset=30 xadvance=43 page=0 chnl=0 letter="x"
char id=60 x=635 y=224 width=45 height=46 xoffset=6 yoffset=23 xadvance=50 page=0 chnl=0 letter="<"
char id=62 x=682 y=224 width=45 height=46 xoffset=6 yoffset=23 xadvance=50 page=0 chnl=0 letter=">"
char id=43 x=729 y=224 width=45 height=45 xoffset=5 yoffset=24 xadvance=50 page=0 chnl=0 letter="+"
char id=94 x=776 y=224 width=40 height=38 xoffset=3 yoffset=12 xadvance=38 page=0 chnl=0 letter="^"
char id=61 x=818 y=224 width=45 height=30 xoffset=5 yoffset=31 xadvance=50 page=0 chnl=0 letter="="
char id=42 x=865 y=224 width=32 height=30 xoffset=4 yoffset=13 xadvance=33 page=0 chnl=0 letter="*"
char id=39 x=899 y=224 width=13 height=26 xoffset=5 yoffset=13 xadvance=16 page=0 chnl=0 letter="'"
char id=34 x=914 y=224 width=27 height=26 xoffset=4 yoffset=13 xadvance=30 page=0 chnl=0 letter="""
char id=44 x=943 y=224 width=14 height=25 xoffset=9 yoffset=66 xadvance=24 page=0 chnl=0 letter=","
char id=126 x=959 y=224 width=47 height=18 xoffset=5 yoffset=37 xadvance=50 page=0 chnl=0 letter="~"
char id=96 x=2 y=277 width=20 height=16 xoffset=4 yoffset=13 xadvance=28 page=0 chnl=0 letter="`"
char id=46 x=24 y=277 width=13 height=13 xoffset=9 yoffset=66 xadvance=24 page=0 chnl=0 letter="."
char id=45 x=39 y=277 width=27 height=12 xoffset=4 yoffset=49 xadvance=28 page=0 chnl=0 letter="-"
char id=95 x=68 y=277 width=54 height=10 xoffset=0 yoffset=84 xadvance=47 page=0 chnl=0 letter="_"
char id=32 x=124 y=277 width=4 height=4 xoffset=1 yoffset=74 xadvance=24 page=0 chnl=0 letter=" "
char id=127 x=130 y=277 width=4 height=4 xoffset=1 yoffset=74 xadvance=43 page=0 chnl=0 letter=""
]]

-- things that remain
-- getting lineheight correct
-- offsetx for at least barely tolerable kerning
-- figuring out the subtle offset with the lowercase z, etc - baseline is off, I can tell in gimp
-- abstracting out and testing with two other fonts

-- first, get the chunks of the bmfont file we need into lua tables
bmfontlua = {}

-- turn a string with x=y parameters into a key,value table - see https://www.lua.org/manual/5.3/manual.html#pdf-string.gmatch
-- does not work with strings or multivalue fields such as x=1,2,3,4;  extract those manually if you need 'em
function tableify( str )  
  local t = {}
  -- iterate over patterns of alphanumeric characters=alphanumeric characters, capturing both:
  for k, v in str:gmatch( "(%w+)=(%S+)") do   
  	t[k] = tonumber(v) or v:match( '[^"]+' )  -- if we can convert to a number, do so, otherwise leave as a string, stripping between the ::
  end
  return t
end

--matches line with 'info ' up until first control character which should be end-of-line:
bmfontlua.info = tableify( string.match( bmfont, 'info%s.-%c' ) )  

--because tableify doesn't capture multivalues we need to grab spacing ourselves
--there's probably a more compact way to do this
local spacingx
local spacingy
spacingx, spacingy = string.match( bmfont, 'spacing=(%w+),(%w+)' )
bmfontlua.info.spacing = { tonumber(spacingx), tonumber(spacingy) }

bmfontlua.common = tableify( string.match( bmfont, 'common%s.-%c' ) )  

--for sanity checking extract the number of chars from the file
local charsCount = string.match( bmfont, 'chars%scount=(%w+)' )
print( 'charsCount = '..charsCount )

--read each char line and put it in a chars table; iterating over text that starts with 'char ' and ends with end-of-line
bmfontlua.chars = {}
local lineCount = 0
for charLine in string.gmatch(bmfont, 'char%s.-%c') do
  print( charLine )
  local charTable = tableify( charLine )
  -- extracting the letter field nontrivial but would be a good sanity check.  still, let's use id
  -- there are pros and cons with converting the id to a string first; let's do it, because that's closer to how the existing fontmap code works
  local charKey = string.char( charTable.id )
  bmfontlua.chars[charKey] = charTable
  lineCount = lineCount + 1
end

-- sanity check
print( "charsCount "..charsCount )
print( "lineCount "..lineCount )
--assert( charsCount == lineCount )  -- definitely don't match, but that looks like something to do with the arial file?
	
-- ok! now the original file is in lua data form, but we still have to convert it to the sort of data that the FontCreator likes

return bmfontlua
-- and ignore kernings for now